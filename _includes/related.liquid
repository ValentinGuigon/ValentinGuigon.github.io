{%- if page['content-type'] == 'post' -%}
  {%- assign sameTagCount = 0 -%}
  {%- assign minCommonTags = 1 -%}

  {%- for post in site.posts -%}
    {%- if post.url != page.url -%}
      {%- for tag in post.tags -%}
        {%- if page.tags contains tag -%}
          {%- unless post.content contains page.title -%}
            {%- assign sameTagCount = sameTagCount | plus: 1 -%}
          {%- endunless -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if sameTagCount >= minCommonTags -%}
    {%- assign display_class = 'hide' -%}
    {%- if site.preferences.related.enabled -%}
      {%- assign display_class = 'show' -%}
    {%- endif -%}

    <div class="related {{ display_class }}" id="jekyll-seamless-relatedposts">
      <h5 class="block-title">Related Posts</h5>
      <div class="related-wrapper">
        {%- assign maxRelated = 8 -%}
        {%- assign maxRelatedCounter = 0 -%}

        {%- for post in site.posts -%}
          {%- assign sameTagCount = 0 -%}
          {%- assign commonTags = '' -%}

          {%- if post.url != page.url -%}
            {%- for tag in post.tags -%}
              {%- if page.tags contains tag -%}
                {%- unless post.content contains page.title -%}
                  {%- assign sameTagCount = sameTagCount | plus: 1 -%}
                  {%- capture tagmarkup -%} 
                    <span class="label label-default">{{ tag }}</span> 
                  {%- endcapture -%}
                  {%- assign commonTags = commonTags | append: tagmarkup -%}
                {%- endunless -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}

          {%- if sameTagCount >= minCommonTags -%}
            <div class="related-group">
              <a href="{{ post.url }}">
                <h4>{{ post.title }}</h4>
                <p class="excerpt">{{ post.content | markdownify | strip_html | truncate: 100 }}</p>
              </a>
            </div>
            {%- assign maxRelatedCounter = maxRelatedCounter | plus: 1 -%}
            {%- if maxRelatedCounter >= maxRelated -%}
              {%- break -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
      <br>
    </div>
  {%- endif -%}
{%- endif -%}
